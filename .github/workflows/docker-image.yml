# .github/workflows/deploy.yml
# ğŸš€ Pipeline CI/CD con SonarQube y despliegue en Docker (Self-Hosted Runner)

name: CI/CD with SonarQube and Docker

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKER_PROJECT_NAME: 'exam'
  APP_CONTAINER_NAME: 'product_app'

jobs:
  build-and-deploy:
    name: Build, Analyze and Deploy
    runs-on: self-hosted

    steps:
      - name: ğŸ§¾ Checkout del repositorio
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: ğŸ—ï¸ Compilar proyecto con Maven
        run: mvn -B clean package -DskipTests

      - name: ğŸ” AnÃ¡lisis estÃ¡tico con SonarQube
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=exam \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.login=${SONAR_TOKEN}

      - name: ğŸ³ Desplegar con Docker Compose
        run: |
          echo "âœ… Iniciando despliegue en runner local..."

          cd docker

          echo "ğŸ§¹ Limpiando despliegue anterior..."
          docker-compose -p ${{ env.DOCKER_PROJECT_NAME }} down -v --remove-orphans || echo "No hay contenedores previos."

          echo "ğŸ—ï¸ Levantando contenedor de la app..."
          docker-compose -p ${{ env.DOCKER_PROJECT_NAME }} up -d --build

          echo "ğŸ” Estado de los contenedores:"
          docker-compose -p ${{ env.DOCKER_PROJECT_NAME }} ps

          echo "ğŸ“„ Ãšltimos logs de la app:"
          docker logs --tail 50 ${{ env.APP_CONTAINER_NAME }}
